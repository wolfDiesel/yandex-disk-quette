name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    container: fedora:40
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf install -y \
            git cmake gcc-c++ \
            qt6-qtbase-devel \
            qt6-qttools-devel \
            qt6-qtwebengine-devel \
            mesa-libGL-devel libxkbcommon-devel vulkan-headers \
            wget

      - name: Configure and build
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --test-dir . --output-on-failure

      - name: Prepare AppDir
        run: |
          cd build
          mkdir -p AppDir/usr/bin AppDir/usr/share/applications
          cp Y.Disquette AppDir/usr/bin/
          printf '[Desktop Entry]\nType=Application\nName=Y.Disquette\nExec=Y.Disquette\nIcon=y_disquette\nCategories=Network;\n' > AppDir/usr/share/applications/y.disquette.desktop

      - name: Download linuxdeploy
        run: |
          cd build
          wget -q -O linuxdeploy-x86_64.AppImage \
            https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Download Qt plugin
        run: |
          cd build
          wget -q -O linuxdeploy-plugin-qt.AppImage \
            https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-plugin-qt.AppImage

      - name: Build AppImage
        id: build-appimage
        env:
          VERSION: ${{ github.ref_name }}
          APPIMAGE_EXTRACT_AND_RUN: 1
        run: |
          cd build
          VERSION=${VERSION#v}
          export QTDIR=/usr/lib64/qt6
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage \
            -e AppDir/usr/bin/Y.Disquette \
            -i /usr/share/icons/hicolor/256x256/apps/application-x-executable.png \
            --plugin qt || true
          chmod +x *.AppImage 2>/dev/null || true
          OUTNAME="Y.Disquette-${VERSION}-x86_64.AppImage"
          for f in *.AppImage; do
            case "$f" in linuxdeploy*|linuxdeploy-plugin*) ;; *)
              mv -f "$f" "$OUTNAME"
              break
            ;; esac
          done
          cp -f "$OUTNAME" "$GITHUB_WORKSPACE/$OUTNAME"
          echo "path=$OUTNAME" >> "$GITHUB_OUTPUT"
          ls -la "$GITHUB_WORKSPACE/$OUTNAME"

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Y.Disquette-${{ github.ref_name }}-x86_64.AppImage
          path: ${{ steps.build-appimage.outputs.path }}
          if-no-files-found: error

      - name: Create Release and upload AppImage
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-appimage.outputs.path }}
          fail_on_unmatched_files: false
          generate_release_notes: true
