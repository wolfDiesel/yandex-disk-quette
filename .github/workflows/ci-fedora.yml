name: CI

on:
  push:
    tags: ['v*.*.*']

jobs:
  test:
    if: false
    runs-on: ubuntu-22.04
    container: fedora:40
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf install -y dnf-plugins-core
          dnf config-manager --set-disabled fedora-cisco-openh264 || true
          dnf install -y \
            git gcc-c++ cmake \
            qt6-qtbase-devel qt6-qttools-devel qt6-qtwebengine-devel \
            mesa-libGL-devel libxkbcommon-devel vulkan-headers

      - name: Configure
        run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -j4

      - name: Test
        run: ctest --test-dir build --output-on-failure

  build:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-22.04
    container: fedora:40
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf install -y dnf-plugins-core
          dnf config-manager --set-disabled fedora-cisco-openh264 || true
          dnf install -y \
            git gcc-c++ cmake python3 wget file ImageMagick \
            qt6-qtbase-devel qt6-qttools-devel qt6-qtwebengine-devel \
            mesa-libGL-devel libxkbcommon-devel vulkan-headers

      - name: Configure and build
        env:
          YDISQUETTE_CLIENT_ID: ${{ secrets.YDISQUETTE_CLIENT_ID }}
          YDISQUETTE_CLIENT_SECRET: ${{ secrets.YDISQUETTE_CLIENT_SECRET }}
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j4

      - name: Prepare AppDir
        run: |
          mkdir -p build/AppDir/usr/bin
          mkdir -p build/AppDir/usr/share/applications
          mkdir -p build/AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p build/AppDir/apprun-hooks
          cp build/Y.Disquette build/AppDir/usr/bin/
          convert res/icon.png -resize 256x256 build/AppDir/usr/share/icons/hicolor/256x256/apps/y_disquette.png
          printf '[Desktop Entry]\nType=Application\nName=Y.Disquette\nExec=Y.Disquette\nIcon=y_disquette\nCategories=Network;\n' > build/AppDir/usr/share/applications/y.disquette.desktop
          printf '%s\n' \
            '#!/bin/sh' \
            'SYS_QTLIB="/usr/lib64/qt6:/usr/lib/qt6:/usr/lib/x86_64-linux-gnu/qt6"' \
            'SYS_QTPLUGINS="/usr/lib64/qt6/plugins:/usr/lib/qt6/plugins:/usr/lib/x86_64-linux-gnu/qt6/plugins"' \
            'export LD_LIBRARY_PATH="${SYS_QTLIB}:${SYS_QTLIB}/lib:/usr/lib64:/usr/lib:${LD_LIBRARY_PATH}"' \
            'export QT_PLUGIN_PATH="${SYS_QTPLUGINS}:${QT_PLUGIN_PATH}"' \
            > build/AppDir/apprun-hooks/01-system-qt-plugins.sh
          chmod +x build/AppDir/apprun-hooks/01-system-qt-plugins.sh

      - name: Download linuxdeploy and Qt plugin
        run: |
          cd build
          wget -q -O linuxdeploy-x86_64.AppImage \
            https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q -O linuxdeploy-plugin-qt-x86_64.AppImage \
            https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage linuxdeploy-plugin-qt-x86_64.AppImage

      - name: Build AppImage
        id: appimage
        env:
          VERSION: ${{ github.ref_name }}
          APPIMAGE_EXTRACT_AND_RUN: 1
          NO_STRIP: 1
        run: |
          cd build
          ver="${VERSION#v}"
          export QTDIR=/usr/lib64/qt6
          export LDAI_OUTPUT="Y.Disquette-${ver}-x86_64.AppImage"
          ./linuxdeploy-x86_64.AppImage --appdir AppDir \
            -e AppDir/usr/bin/Y.Disquette \
            -d AppDir/usr/share/applications/y.disquette.desktop \
            -i AppDir/usr/share/icons/hicolor/256x256/apps/y_disquette.png \
            --plugin qt --output appimage
          test -f "Y.Disquette-${ver}-x86_64.AppImage" || (echo "AppImage was not created" && exit 1)
          echo "name=Y.Disquette-${ver}-x86_64.AppImage" >> "$GITHUB_OUTPUT"
          cp -f "Y.Disquette-${ver}-x86_64.AppImage" "$GITHUB_WORKSPACE/"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Y.Disquette-${{ github.ref_name }}
          path: |
            build/Y.Disquette
            ${{ steps.appimage.outputs.name }}
          retention-days: 30

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: Y.Disquette-${{ github.ref_name }}
          path: release

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            release/build/Y.Disquette
            release/Y.Disquette-*-x86_64.AppImage
          fail_on_unmatched_files: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
