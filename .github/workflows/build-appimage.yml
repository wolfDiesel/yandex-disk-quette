name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential
          sudo apt-get install -y qt6-base-dev qt6-tools-dev qt6-webengine-dev
          sudo apt-get install -y libxcb-cursor0 libxkbcommon-dev libgl1-mesa-dev

      - name: Configure and build
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --test-dir . --output-on-failure

      - name: Prepare AppDir
        run: |
          cd build
          mkdir -p AppDir/usr/bin AppDir/usr/share/applications
          cp Y.Disquette AppDir/usr/bin/
          printf '[Desktop Entry]\nType=Application\nName=Y.Disquette\nExec=Y.Disquette\nIcon=y_disquette\nCategories=Network;\n' > AppDir/usr/share/applications/y.disquette.desktop

      - name: Download linuxdeploy
        run: |
          cd build
          wget -q -O linuxdeploy-x86_64.AppImage \
            https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Download Qt plugin
        run: |
          cd build
          wget -q -O linuxdeploy-plugin-qt-x86_64.AppImage \
            https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-plugin-qt-x86_64.AppImage

      - name: Build AppImage
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          cd build
          export VERSION=${VERSION#v}
          export QTDIR=/usr/lib/x86_64-linux-gnu/qt6
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage \
            -e AppDir/usr/bin/Y.Disquette \
            -i /usr/share/icons/hicolor/256x256/apps/application-x-executable.png \
            --plugin qt || true
          chmod +x *.AppImage 2>/dev/null || true

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Y.Disquette-${{ github.ref_name }}-x86_64.AppImage
          path: build/*.AppImage
          if-no-files-found: ignore

      - name: Create Release and upload AppImage
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: build/*.AppImage
          fail_on_unmatched_files: false
          generate_release_notes: true
