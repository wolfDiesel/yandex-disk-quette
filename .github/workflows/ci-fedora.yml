name: CI

on:
  push:
    tags: ['v*.*.*']

jobs:
  test:
    runs-on: ubuntu-22.04
    container: fedora:40
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf install -y \
            git gcc-c++ cmake \
            qt6-qtbase-devel qt6-qttools-devel qt6-qtwebengine-devel \
            mesa-libGL-devel libxkbcommon-devel vulkan-headers

      - name: Configure
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -j4

      - name: Test
        run: ctest --test-dir build --output-on-failure

  build:
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-22.04
    container: fedora:40
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf install -y \
            git gcc-c++ cmake wget \
            qt6-qtbase-devel qt6-qttools-devel qt6-qtwebengine-devel \
            mesa-libGL-devel libxkbcommon-devel vulkan-headers

      - name: Configure
        run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -j4

      - name: Prepare AppDir
        run: |
          mkdir -p build/AppDir/usr/bin build/AppDir/usr/share/applications
          mkdir -p build/AppDir/usr/share/icons/hicolor/256x256/apps
          cp build/Y.Disquette build/AppDir/usr/bin/
          cp res/icon.png build/AppDir/usr/share/icons/hicolor/256x256/apps/y_disquette.png
          printf '[Desktop Entry]\nType=Application\nName=Y.Disquette\nExec=Y.Disquette\nIcon=y_disquette\nCategories=Network;\n' > build/AppDir/usr/share/applications/y.disquette.desktop

      - name: Download linuxdeploy and Qt plugin
        run: |
          cd build
          wget -q -O linuxdeploy-x86_64.AppImage \
            https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q -O linuxdeploy-plugin-qt.AppImage \
            https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage linuxdeploy-plugin-qt.AppImage

      - name: Build AppImage
        id: appimage
        env:
          VERSION: ${{ github.ref_name }}
          APPIMAGE_EXTRACT_AND_RUN: 1
          NO_STRIP: 1
        run: |
          cd build
          ver=${VERSION#v}
          export QTDIR=/usr/lib64/qt6
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage \
            -e AppDir/usr/bin/Y.Disquette \
            -i AppDir/usr/share/icons/hicolor/256x256/apps/y_disquette.png \
            --plugin qt || true
          out="Y.Disquette-${ver}-x86_64.AppImage"
          for f in *.AppImage; do
            case "$f" in linuxdeploy*) ;; linuxdeploy-plugin*) ;; *)
              mv -f "$f" "$out"
              cp -f "$out" "$GITHUB_WORKSPACE/$out"
              echo "path=$out" >> "$GITHUB_OUTPUT"
              exit 0
            ;; esac
          done
          echo "path=" >> "$GITHUB_OUTPUT"
          exit 1

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Y.Disquette-${{ github.ref_name }}
          path: |
            build/Y.Disquette
            ${{ steps.appimage.outputs.path }}
          retention-days: 30

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: Y.Disquette-${{ github.ref_name }}
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            artifacts/Y.Disquette
            artifacts/Y.Disquette-*-x86_64.AppImage
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
